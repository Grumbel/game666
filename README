In middle of rewrite in C++, currently doesn't compile
